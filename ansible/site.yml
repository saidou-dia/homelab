---
- name: Homelab – Déploiement complet
  hosts: all
  become: true
  gather_facts: true

  vars_files:
    - vault.yml   # Variables chiffrées avec Vault

  roles:
    - role: common

- name: Configuration réseau
  hosts: all
  become: true
  roles:
    - network

- name: Configuration système
  hosts: all
  become: true
  roles:
    - system

- name: Installation base de données
  hosts: vms
  become: true
  roles:
    - database

- name: Services applicatifs
  hosts: vms
  become: true
  roles:
    - services

- name: Monitoring
  hosts: all
  become: true
  roles:
    - monitoring

# Mise à jour et installation spécifique
- name: Gestion des paquets PVE et mise à jour de tous les systèmes
  hosts: all
  become: true
  roles:
    - role: system
      tasks_from: install.yml   # Installe les paquets seulement sur PVE
      when: "'pve' in group_names"

- name: Mise à jour complète (PVE + VMs)
  hosts: all
  become: true
  roles:
    - role: system
      tasks_from: update.yml    # Met à jour toutes les machines

